service: {{func_id|replace("_","-")}}
provider:
  name: aws
  stage: {{environment}}
  runtime: python3.8
  region: {{region}}
  memorySize: {{memory_size}}
  environment:
    CORE_LAMBDA_FRAMEWORK: "1.0"
  deploymentBucket:
    name: {{deployment_bucket_name}} # Deployment bucket name. Default is generated by the framework
    maxPreviousDeploymentArtifacts: 10 # On every deployment the framework prunes the bucket to remove artifacts older than this limit. The default is 5

  {% if layers is defined %}
layers:
  {% for layer_name, layer_path in layers.items() %}
    {{layer_name}}:
    {{layer_name}}:{{layer_path}}
    {% endfor %}
    {% endif %}



package:
  exclude:
    - ./**
  include:
    - {{relative_function_path}}/**
    - core/**
    - '!**/.pytest_cache/**'
    - '!**/__pycache__/**'

plugins:
  - serverless-step-functions
  - serverless-pseudo-parameters
  - serverless-python-requirements
  {% if step_function %}
stepFunctions:
  stateMachines:
    ${file(./{{relative_function_path}}/step_functions.yml):stateMachines}
  {% endif %}



custom:
  pythonRequirements:
    usePipenv: false
    useDownloadCache: false
    fileName: {{func_id}}_requirements.txt
    useStaticCache: false
    dockerizePip: non-linux
    zip: true
    noDeploy:
      - pytest
    {% if no_deploy_packages is defined %}
    {% for value in no_deploy_packages %}
    - {{value}}
    {% endfor %}
    {% endif %}
  externalConfigurations:
  {% for key, value in lambda_external_configurations.items() %}
    {{key}}: {{value}}
  {% endfor %}
    relative_function_path: {{relative_function_path}}


functions:
  - ${file(./{{relative_function_path}}/functions.yml)}